<!DOCTYPE html>
<html lang="lt">
<head>
  <meta charset="UTF-8" />
  <title>Seimo narių balsavimo statistika</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 20px;
      font-size: 1.0rem;
    }

    h1 {
      font-size: 1.8rem;
      margin-bottom: 0.3rem;
    }

    .subtitle {
      font-size: 0.95rem;
      color: #444;
      margin-bottom: 0.4rem;
    }

    .period {
      font-size: 0.95rem;
      color: #222;
      margin-bottom: 0.4rem;
    }

    .source-note {
      margin: 6px 0 16px 0;
      padding: 8px 12px;
      border-left: 4px solid #555;
      background: #f9f9f9;
      font-size: 0.95rem;
      line-height: 1.4;
    }

    .filters-row {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: center;
      margin-bottom: 8px;
    }

    .filters-row > div {
      display: flex;
      flex-direction: column;
    }

    label {
      font-weight: 600;
      margin-bottom: 2px;
    }

    select {
      min-width: 220px;
      padding: 5px 8px;
      font-size: 0.95rem;
    }

    .status {
      margin-top: 6px;
      margin-bottom: 6px;
      font-size: 0.93rem;
      color: #555;
    }

    .error {
      margin-top: 6px;
      margin-bottom: 6px;
      font-size: 0.95rem;
      color: #b00020;
      font-weight: 600;
    }

    .table-wrapper {
      max-width: 100%;
      overflow-x: auto;
      margin-top: 8px;
    }

    .table-container {
      max-height: 75vh;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      min-width: 900px;
    }

    th, td {
      border-bottom: 1px solid #e0e0e0;
      padding: 4px 6px;
      font-size: 0.95rem;
      line-height: 1.25;
    }

    th {
      background: #f6f6f6;
      text-align: left;
      font-weight: 700;
      position: sticky;
      top: 0;
      z-index: 2;
    }

    tr:nth-child(even) td {
      background: #fafafa;
    }

    .number-cell {
      text-align: right;
      white-space: nowrap;
    }

    .index-cell {
      text-align: right;
      width: 40px;
      white-space: nowrap;
    }

    .name-cell {
      white-space: nowrap;
      width: 230px;
    }

    .party-cell {
      white-space: nowrap;
      width: 200px;
    }

    .party-badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 0.88rem;
      font-weight: 600;
      color: #fff;
      white-space: nowrap;
    }

    .sortable {
      cursor: pointer;
      user-select: none;
    }

    .sortable::after {
      content: " ⇅";
      font-size: 0.8rem;
      color: #999;
    }

    .sortable.sorted-asc::after {
      content: " ↑";
      color: #555;
    }

    .sortable.sorted-desc::after {
      content: " ↓";
      color: #555;
    }

    .hint {
      margin-top: 4px;
      font-size: 0.9rem;
      color: #777;
    }

    @media (max-width: 768px) {
      body {
        margin: 10px;
        font-size: 0.95rem;
      }
      h1 {
        font-size: 1.4rem;
      }
      .subtitle,
      .period {
        font-size: 0.9rem;
      }
      select {
        min-width: 180px;
      }
      table {
        min-width: 800px;
      }
    }
  </style>
</head>
<body>
  <h1>Seimo narių balsavimo statistika</h1>
  <div class="subtitle">Metinė statistika.</div>
  <div class="period">Pirmieji kadencijos metai: <b>2024-11-14 – 2025-11-14</b></div>

  <div class="source-note">
    <b>Privaloma šaltinio nuoroda.</b><br />
    Duomenys paimti iš Seimo nario Vitalijaus Šeršniovo parengto šaltinio.
  </div>

  <div class="filters-row">
    <div>
      <label for="partyFilter">Filtruoti pagal partiją:</label>
      <select id="partyFilter">
        <option value="ALL">Visos partijos</option>
      </select>
    </div>
    <div>
      <label for="sortMetric">Rikiuoti pagal rodiklį:</label>
      <select id="sortMetric">
        <option value="">— Pasirinkti rodiklį —</option>
        <option value="name">Seimo narys (abėcėle)</option>
        <option value="party">Partija / frakcija</option>
        <option value="nedalyvavo">Nedalyvavo (↓)</option>
        <option value="pries">Prieš (↓)</option>
        <option value="uz">Už (↓)</option>
        <option value="susilaike">Susilaikė (↓)</option>
        <option value="registravosi">Registravosi (↓)</option>
        <option value="uzA">Už A (↓)</option>
        <option value="uzB">Už B (↓)</option>
      </select>
    </div>
  </div>

  <div id="status" class="status">Bandome įkelti duomenis...</div>
  <div id="error" class="error" style="display:none;"></div>

  <div class="table-wrapper">
    <div class="table-container">
      <table id="statsTable">
        <thead>
          <tr>
            <th>#</th>
            <th class="sortable" data-sort-key="name">Seimo narys</th>
            <th class="sortable" data-sort-key="party">Partija</th>
            <th class="sortable" data-sort-key="nedalyvavo">Nedalyvavo</th>
            <th class="sortable" data-sort-key="pries">Prieš</th>
            <th class="sortable" data-sort-key="uz">Už</th>
            <th class="sortable" data-sort-key="susilaike">Susilaikė</th>
            <th class="sortable" data-sort-key="registravosi">Registravosi</th>
            <th class="sortable" data-sort-key="uzA">Už A</th>
            <th class="sortable" data-sort-key="uzB">Už B</th>
          </tr>
        </thead>
        <tbody id="statsBody">
          <!-- Eilutės bus sugeneruotos čia -->
        </tbody>
      </table>
    </div>
  </div>

  <div class="hint">
    Pastaba: skaičiai rodo, kiek kartų per pirmuosius kadencijos metus Seimo narys balsavo atitinkamu būdu.
  </div>

  <script>
    // Duomenų struktūra
    const dataRows = []; // { name, partyName, partyCategory, nedalyvavo, pries, uz, susilaike, registravosi, uzA, uzB }
    const memberParty = {}; // iš members_parties.csv

    const partyFilterSelect = document.getElementById("partyFilter");
    const sortMetricSelect = document.getElementById("sortMetric");
    const statusEl = document.getElementById("status");
    const errorEl = document.getElementById("error");
    const statsBody = document.getElementById("statsBody");

    let currentPartyFilter = "ALL";
    let currentSort = { key: "name", direction: "asc" };

    // Partijų kategorijos ir spalvos (tokios pat kaip kitame instrumente)
    const categoryColors = {
      "Tėvynės sąjunga–LKD": "#43BBAE",
      "Liberalai": "#FDBB38",
      "Demokratai": "#3A5778",
      "Socialdemokratai": "#FA0016",
      "Lietuvos valstiečių, žaliųjų ir KŠS frakcija": "#95D05F",
      "Mišri grupė": "#868A8D",
      "Nemuno aušra": "#9A4418"
    };

    function getPartyCategory(partyName) {
      if (!partyName) return "";
      const p = partyName.toLowerCase();

      if (p.startsWith("mišri grupė")) return "Mišri grupė";
      if (p.includes("nemuno aušra")) return "Nemuno aušra";
      if (p.includes("tėvynės sąjunga") || p.includes("tėvynės sajunga") || p.includes("ts-lkd")) {
        return "Tėvynės sąjunga–LKD";
      }
      if (p.includes("liberalų sąjūdis") || p.includes("liberalai")) {
        return "Liberalai";
      }
      if (p.includes("socialdemokrat")) {
        return "Socialdemokratai";
      }
      if (p.includes("demokratų sąjunga") || p.includes("vardan lietuvos")) {
        return "Demokratai";
      }
      if (p.includes("valstiečių") || p.includes("žaliųjų") || p.includes("žaliuju") || p.includes("kšs")) {
        return "Lietuvos valstiečių, žaliųjų ir KŠS frakcija";
      }
      return partyName.trim();
    }

    function getPartyColor(category) {
      if (!category) return "#9e9e9e";
      return categoryColors[category] || "#9e9e9e";
    }

    function parseInteger(value) {
      if (!value) return 0;
      const cleaned = value.replace(/\s/g, "").replace(",", ".");
      const num = Number(cleaned);
      return Number.isFinite(num) ? num : 0;
    }

    function detectDelimiter(headerLine) {
      // Jei yra tik kabliataškiai – naudosim ;, jei tik kableliai – ,
      if (headerLine.includes(";") && !headerLine.includes(",")) return ";";
      if (headerLine.includes(",") && !headerLine.includes(";")) return ",";
      // jei abu – bandome su kabliataškiu kaip dažnesniu Excel LT variantu
      return ";";
    }

    async function loadStats() {
      const response = await fetch("metu_balsavimas1.csv");
      if (!response.ok) {
        throw new Error("Nepavyko nuskaityti failo „metu_balsavimas1.csv“. Patikrink, ar jis yra šalia HTML.");
      }
      const text = await response.text();
      const lines = text.split(/\r?\n/).filter(line => line.trim().length > 0);
      if (lines.length < 2) {
        throw new Error("„metu_balsavimas1.csv“ faile per mažai eilučių.");
      }

      const headerLine = lines[0];
      const delimiter = detectDelimiter(headerLine);
      const headers = headerLine.split(delimiter).map(h => h.trim());

      const idxName         = headers.findIndex(h => h.toLowerCase() === "seimo nariai");
      const idxNedalyvavo   = headers.findIndex(h => h.toLowerCase() === "nedalyvavo");
      const idxPries        = headers.findIndex(h => h.toLowerCase() === "prieš" || h.toLowerCase() === "pries");
      const idxUz           = headers.findIndex(h => h.toLowerCase() === "už" || h.toLowerCase() === "uz");
      const idxSusilaike    = headers.findIndex(h => h.toLowerCase() === "susilaikė" || h.toLowerCase() === "susilaike");
      const idxRegistravosi = headers.findIndex(h => h.toLowerCase() === "registravosi");
      const idxUzA          = headers.findIndex(h => h.toLowerCase() === "už a" || h.toLowerCase() === "uz a");
      const idxUzB          = headers.findIndex(h => h.toLowerCase() === "už b" || h.toLowerCase() === "uz b");

      const requiredMissing =
        idxName === -1 ||
        idxNedalyvavo === -1 ||
        idxPries === -1 ||
        idxUz === -1 ||
        idxSusilaike === -1 ||
        idxRegistravosi === -1 ||
        idxUzA === -1 ||
        idxUzB === -1;

      if (requiredMissing) {
        throw new Error("„metu_balsavimas1.csv“ antraštėje turi būti stulpeliai: Seimo nariai, Nedalyvavo, Prieš, Už, Susilaikė, Registravosi, Už A, Už B.");
      }

      for (let i = 1; i < lines.length; i++) {
        const line = lines[i];
        if (!line.trim()) continue;
        const cols = line.split(delimiter);

        if (cols.length <= idxName) continue;

        const name = (cols[idxName] || "").trim();
        if (!name) continue;

        const row = {
          name,
          partyName: "",
          partyCategory: "",
          nedalyvavo:   parseInteger(cols[idxNedalyvavo]),
          pries:        parseInteger(cols[idxPries]),
          uz:           parseInteger(cols[idxUz]),
          susilaike:    parseInteger(cols[idxSusilaike]),
          registravosi: parseInteger(cols[idxRegistravosi]),
          uzA:          parseInteger(cols[idxUzA]),
          uzB:          parseInteger(cols[idxUzB])
        };

        dataRows.push(row);
      }
    }

    async function loadParties() {
      try {
        const response = await fetch("members_parties.csv");
        if (!response.ok) {
          console.warn("Nepavyko nuskaityti „members_parties.csv“. Partijos nebus rodomos.");
          return;
        }
        const text = await response.text();
        const lines = text.split(/\r?\n/).filter(line => line.trim().length > 0);
        if (lines.length < 2) {
          console.warn("„members_parties.csv“ faile per mažai eilučių.");
          return;
        }

        const headerLine = lines[0];
        const delimiter = detectDelimiter(headerLine);
        const headers = headerLine.split(delimiter).map(h => h.trim());

        const idxMember = headers.findIndex(h => h.toLowerCase() === "member");
        const idxParty  = headers.findIndex(h => h.toLowerCase() === "party");

        if (idxMember === -1 || idxParty === -1) {
          console.warn("„members_parties.csv“ antraštėje turi būti stulpeliai: member, party.");
          return;
        }

        for (let i = 1; i < lines.length; i++) {
          const line = lines[i];
          if (!line.trim()) continue;
          const cols = line.split(delimiter);
          if (cols.length <= Math.max(idxMember, idxParty)) continue;

          const member = (cols[idxMember] || "").trim();
          const party  = (cols[idxParty] || "").trim();
          if (!member) continue;

          memberParty[member] = party;
        }
      } catch (err) {
        console.error("Klaida skaitant „members_parties.csv“:", err);
      }
    }

    function attachParties() {
      dataRows.forEach(row => {
        const partyName = memberParty[row.name] || "";
        row.partyName = partyName;
        row.partyCategory = getPartyCategory(partyName);
      });
    }

    function buildPartyFilterOptions() {
      const categories = new Set();
      dataRows.forEach(row => {
        if (row.partyCategory && row.partyCategory.trim()) {
          categories.add(row.partyCategory.trim());
        }
      });

      const sorted = Array.from(categories).sort((a, b) => a.localeCompare(b, "lt"));

      partyFilterSelect.innerHTML = "";
      const allOpt = document.createElement("option");
      allOpt.value = "ALL";
      allOpt.textContent = "Visos partijos";
      partyFilterSelect.appendChild(allOpt);

      sorted.forEach(cat => {
        const opt = document.createElement("option");
        opt.value = cat;
        opt.textContent = cat;
        partyFilterSelect.appendChild(opt);
      });
    }

    function fmtNumber(n) {
      return n.toLocaleString("lt-LT");
    }

    function renderTable() {
      statsBody.innerHTML = "";

      let rows = dataRows.slice();

      if (currentPartyFilter !== "ALL") {
        rows = rows.filter(r => r.partyCategory === currentPartyFilter);
      }

      rows.sort((a, b) => {
        const dir = currentSort.direction === "asc" ? 1 : -1;
        const key = currentSort.key;

        if (key === "name") {
          return a.name.localeCompare(b.name, "lt") * dir;
        }
        if (key === "party") {
          return a.partyCategory.localeCompare(b.partyCategory, "lt") * dir;
        }

        // skaitiniai rodikliai
        return (a[key] - b[key]) * dir;
      });

      document.querySelectorAll("th.sortable").forEach(th => {
        th.classList.remove("sorted-asc", "sorted-desc");
        const key = th.getAttribute("data-sort-key");
        if (key === currentSort.key) {
          th.classList.add(currentSort.direction === "asc" ? "sorted-asc" : "sorted-desc");
        }
      });

      rows.forEach((row, idx) => {
        const tr = document.createElement("tr");

        const tdIndex = document.createElement("td");
        tdIndex.className = "index-cell";
        tdIndex.textContent = idx + 1;
        tr.appendChild(tdIndex);

        const tdName = document.createElement("td");
        tdName.className = "name-cell";
        tdName.textContent = row.name;
        tr.appendChild(tdName);

        const tdParty = document.createElement("td");
        tdParty.className = "party-cell";
        if (row.partyName) {
          const span = document.createElement("span");
          span.className = "party-badge";
          span.style.backgroundColor = getPartyColor(row.partyCategory);
          span.textContent = row.partyName;
          tdParty.appendChild(span);
        }
        tr.appendChild(tdParty);

        const tdNed = document.createElement("td");
        tdNed.className = "number-cell";
        tdNed.textContent = fmtNumber(row.nedalyvavo);
        tr.appendChild(tdNed);

        const tdPries = document.createElement("td");
        tdPries.className = "number-cell";
        tdPries.textContent = fmtNumber(row.pries);
        tr.appendChild(tdPries);

        const tdUz = document.createElement("td");
        tdUz.className = "number-cell";
        tdUz.textContent = fmtNumber(row.uz);
        tr.appendChild(tdUz);

        const tdSus = document.createElement("td");
        tdSus.className = "number-cell";
        tdSus.textContent = fmtNumber(row.susilaike);
        tr.appendChild(tdSus);

        const tdReg = document.createElement("td");
        tdReg.className = "number-cell";
        tdReg.textContent = fmtNumber(row.registravosi);
        tr.appendChild(tdReg);

        const tdUzA = document.createElement("td");
        tdUzA.className = "number-cell";
        tdUzA.textContent = fmtNumber(row.uzA);
        tr.appendChild(tdUzA);

        const tdUzB = document.createElement("td");
        tdUzB.className = "number-cell";
        tdUzB.textContent = fmtNumber(row.uzB);
        tr.appendChild(tdUzB);

        statsBody.appendChild(tr);
      });
    }

    // Įvykiai
    partyFilterSelect.addEventListener("change", () => {
      currentPartyFilter = partyFilterSelect.value || "ALL";
      renderTable();
    });

    sortMetricSelect.addEventListener("change", () => {
      const value = sortMetricSelect.value;
      if (!value) {
        currentSort = { key: "name", direction: "asc" };
      } else if (value === "name") {
        currentSort = { key: "name", direction: "asc" };
      } else if (value === "party") {
        currentSort = { key: "party", direction: "asc" };
      } else {
        currentSort = { key: value, direction: "desc" };
      }
      renderTable();
    });

    document.querySelectorAll("th.sortable").forEach(th => {
      th.addEventListener("click", () => {
        const key = th.getAttribute("data-sort-key");
        if (!key) return;
        if (currentSort.key === key) {
          currentSort.direction = currentSort.direction === "asc" ? "desc" : "asc";
        } else {
          currentSort.key = key;
          currentSort.direction = (key === "name" || key === "party") ? "asc" : "desc";
        }
        renderTable();
      });
    });

    // Inicijavimas
    (async function init() {
      try {
        statusEl.textContent = "Kraunami duomenys iš „metu_balsavimas1.csv“...";
        await loadStats();
        statusEl.textContent = "Kraunamos partijos iš „members_parties.csv“...";
        await loadParties();
        attachParties();
        buildPartyFilterOptions();
        statusEl.textContent = "Duomenys įkelti. Galite filtruoti ir rūšiuoti lentelę.";
        errorEl.style.display = "none";
        renderTable();
      } catch (err) {
        console.error(err);
        statusEl.textContent = "";
        errorEl.textContent = err.message;
        errorEl.style.display = "block";
      }
    })();
  </script>
</body>
</html>
