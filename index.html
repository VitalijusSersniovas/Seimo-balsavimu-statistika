<!DOCTYPE html>
<html lang="lt">
<head>
  <meta charset="UTF-8" />
  <title>Seimo narių balsavimo statistika</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 20px;
      font-size: 14px;
    }

    h1 {
      font-size: 1.6rem;
      margin-bottom: 0.3rem;
    }

    .subtitle {
      font-size: 0.95rem;
      color: #444;
      margin-bottom: 0.2rem;
    }

    .range-note {
      font-size: 0.95rem;
      margin-bottom: 0.6rem;
    }

    .source-note {
      margin: 8px 0 14px 0;
      padding: 8px 10px;
      border-left: 4px solid #444;
      background: #f9f9f9;
      font-size: 0.9rem;
      line-height: 1.4;
    }

    .filters-row {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: center;
      margin-bottom: 8px;
    }

    .filters-row label {
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 2px;
    }

    .filters-row select {
      min-width: 200px;
      padding: 4px 8px;
      font-size: 0.9rem;
    }

    .status {
      font-size: 0.9rem;
      color: #555;
      margin-bottom: 6px;
    }

    .error {
      color: #b00020;
      font-weight: 600;
      margin-top: 4px;
      font-size: 0.9rem;
    }

    .table-wrapper {
      max-width: 100%;
      overflow-x: auto;
    }

    .table-container {
      max-height: 75vh;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      min-width: 900px;
    }

    th, td {
      border-bottom: 1px solid #e0e0e0;
      padding: 4px 6px;
      font-size: 0.9rem;
      line-height: 1.3;
      white-space: nowrap;
    }

    th {
      background: #f6f6f6;
      position: sticky;
      top: 0;
      z-index: 2;
    }

    th.num-header {
      text-align: center;
    }

    td.name-cell {
      white-space: nowrap;
    }

    td.party-cell {
      white-space: nowrap;
    }

    td.number-cell {
      text-align: center; /* ČIA – centravimas */
    }

    tr:nth-child(even) td {
      background: #fafafa;
    }

    .party-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 600;
      color: #fff;
      white-space: nowrap;
    }

    .legend {
      margin-top: 6px;
      font-size: 0.8rem;
      color: #555;
    }

    .legend span {
      margin-right: 10px;
    }

    .legend .dot {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 999px;
      margin-right: 4px;
      vertical-align: middle;
    }

    @media (max-width: 768px) {
      body {
        margin: 10px;
      }
      h1 {
        font-size: 1.3rem;
      }
      .filters-row select {
        min-width: 160px;
      }
      table {
        min-width: 800px;
      }
    }
  </style>
</head>
<body>
  <h1>Seimo narių balsavimo statistika</h1>
  <div class="subtitle">Metinė statistika.</div>
  <div class="range-note">Pirmieji kadencijos metai: <b>2024-11-14 – 2025-11-14</b></div>

  <div class="source-note">
    <b>Privaloma šaltinio nuoroda.</b><br />
    Naudojant, cituojant ar dalinantis šioje lentelėje pateikta informacija, būtina aiškiai nurodyti šaltinį:<br />
    <em>„Duomenys paimti iš Seimo nario Vitalijaus Šeršniovo parengto šaltinio.“</em>
  </div>

  <div class="filters-row">
    <div>
      <label for="partyFilter">Filtruoti pagal partiją / frakciją:</label><br>
      <select id="partyFilter">
        <option value="ALL">Visos partijos</option>
      </select>
    </div>
    <div>
      <label for="sortSelect">Rikiuoti pagal rodiklį:</label><br>
      <select id="sortSelect">
        <option value="name_asc">Seimo narys (abėcėlė)</option>
        <option value="party_asc">Partija / frakcija (abėcėlė)</option>
        <option value="nedalyvavo_desc">Nedalyvavo (↓)</option>
        <option value="nedalyvavo_asc">Nedalyvavo (↑)</option>
        <option value="pries_desc">Prieš (↓)</option>
        <option value="pries_asc">Prieš (↑)</option>
        <option value="uz_desc">Už (↓)</option>
        <option value="uz_asc">Už (↑)</option>
        <option value="susilaike_desc">Susilaikė (↓)</option>
        <option value="susilaike_asc">Susilaikė (↑)</option>
        <option value="registravosi_desc">Registravosi (↓)</option>
        <option value="registravosi_asc">Registravosi (↑)</option>
        <option value="uza_desc">Už A (↓)</option>
        <option value="uza_asc">Už A (↑)</option>
        <option value="uzb_desc">Už B (↓)</option>
        <option value="uzb_asc">Už B (↑)</option>
      </select>
    </div>
  </div>

  <div id="status" class="status">Kraunami duomenys...</div>
  <div id="error" class="error" style="display:none;"></div>

  <div class="table-wrapper">
    <div class="table-container">
      <table id="statsTable">
        <thead>
          <tr>
            <th>#</th>
            <th>Seimo narys</th>
            <th>Partija / frakcija</th>
            <th class="num-header">Nedalyvavo</th>
            <th class="num-header">Prieš</th>
            <th class="num-header">Už</th>
            <th class="num-header">Susilaikė</th>
            <th class="num-header">Registravosi</th>
            <th class="num-header">Už A</th>
            <th class="num-header">Už B</th>
          </tr>
        </thead>
        <tbody id="tableBody">
        </tbody>
      </table>
    </div>
  </div>

  <div class="legend">
    <span><span class="dot" style="background:#43BBAE;"></span>Tėvynės sąjunga–LKD</span>
    <span><span class="dot" style="background:#FDBB38;"></span>Liberalai</span>
    <span><span class="dot" style="background:#3A5778;"></span>Demokratai</span>
    <span><span class="dot" style="background:#FA0016;"></span>Socialdemokratai</span>
    <span><span class="dot" style="background:#95D05F;"></span>Lietuvos valstiečių, žaliųjų ir KŠS frakcija</span>
    <span><span class="dot" style="background:#868A8D;"></span>Mišri grupė</span>
    <span><span class="dot" style="background:#9A4418;"></span>Nemuno aušra</span>
  </div>

  <script>
    // ---- Partijų spalvos ----
    const categoryColors = {
      "Tėvynės sąjunga–LKD": "#43BBAE",
      "Liberalai": "#FDBB38",
      "Demokratai": "#3A5778",
      "Socialdemokratai": "#FA0016",
      "Lietuvos valstiečių, žaliųjų ir KŠS frakcija": "#95D05F",
      "Mišri grupė": "#868A8D",
      "Nemuno aušra": "#9A4418"
    };

    function getPartyCategory(partyName) {
      if (!partyName) return "";
      const p = partyName.toLowerCase();

      if (p.startsWith("mišri grupė")) return "Mišri grupė";
      if (p.includes("nemuno aušra")) return "Nemuno aušra";
      if (p.includes("tėvynės sąjunga") || p.includes("tėvynės sajunga") || p.includes("ts-lkd")) {
        return "Tėvynės sąjunga–LKD";
      }
      if (p.includes("liberal")) return "Liberalai";
      if (p.includes("socialdemokrat")) return "Socialdemokratai";
      if (p.includes("demokratų sąjunga") || p.includes("vardan lietuvos")) {
        return "Demokratai";
      }
      if (p.includes("valstiečių") || p.includes("žaliųjų") || p.includes("žaliuju") || p.includes("kšs")) {
        return "Lietuvos valstiečių, žaliųjų ir KŠS frakcija";
      }
      return partyName.trim();
    }

    function getPartyColor(category) {
      if (!category) return "#9e9e9e";
      return categoryColors[category] || "#9e9e9e";
    }

    // ---- Kintamieji ----
    const partyFilterEl = document.getElementById("partyFilter");
    const sortSelectEl = document.getElementById("sortSelect");
    const tableBody = document.getElementById("tableBody");
    const statusEl = document.getElementById("status");
    const errorEl = document.getElementById("error");

    let allRows = [];          // pilna lentele
    let currentPartyFilter = "ALL";
    let currentSort = "name_asc";

    // ---- CSV parsinimas (paprastas, ; arba ,) ----
    function parseSimpleCSV(text) {
      const lines = text.trim().split(/\r?\n/).filter(l => l.trim().length > 0);
      if (!lines.length) return [];
      const delimiter = lines[0].includes(";") ? ";" : ",";
      return lines.map(line => line.split(delimiter).map(c => c.trim()));
    }

    async function loadMembersParties() {
      try {
        const resp = await fetch("members_parties.csv");
        if (!resp.ok) return {};
        const txt = await resp.text();
        const rows = parseSimpleCSV(txt);
        if (rows.length < 2) return {};
        const header = rows[0].map(h => h.toLowerCase());
        const idxMember = header.indexOf("member");
        const idxParty = header.indexOf("party");
        if (idxMember === -1 || idxParty === -1) return {};

        const map = {};
        for (let i = 1; i < rows.length; i++) {
          const r = rows[i];
          const name = r[idxMember] || "";
          const party = r[idxParty] || "";
          if (!name) continue;
          map[name] = party;
        }
        return map;
      } catch (e) {
        console.warn("Nepavyko nuskaityti members_parties.csv:", e);
        return {};
      }
    }

    async function loadStats(partyMap) {
      const resp = await fetch("metu_balsavimas1.csv");
      if (!resp.ok) {
        throw new Error("Nepavyko nuskaityti failo „metu_balsavimas1.csv“. Patikrink, ar jis yra šalia HTML.");
      }
      const txt = await resp.text();
      const rows = parseSimpleCSV(txt);
      if (rows.length < 2) {
        throw new Error("„metu_balsavimas1.csv“ faile per mažai eilučių.");
      }

      const headerRaw = rows[0];
      const header = headerRaw.map(h => h.toLowerCase());

      function findIndex(names) {
        for (const n of names) {
          const idx = header.findIndex(h => h === n || h.startsWith(n));
          if (idx !== -1) return idx;
        }
        return -1;
      }

      const idxName        = findIndex(["seimo nariai"]);
      const idxNedalyvavo  = findIndex(["nedalyvavo"]);
      const idxPries       = findIndex(["prieš", "pries"]);
      const idxUz          = findIndex(["už", "uz"]);
      const idxSusilaike   = findIndex(["susilaikė", "susilaike"]);
      const idxRegistr     = findIndex(["registravosi"]);
      const idxUzA         = findIndex(["už a", "uz a"]);
      const idxUzB         = findIndex(["už b", "uz b"]);

      if (idxName === -1 || idxNedalyvavo === -1 || idxPries === -1 ||
          idxUz === -1 || idxSusilaike === -1 || idxRegistr === -1 ||
          idxUzA === -1 || idxUzB === -1) {
        throw new Error("„metu_balsavimas1.csv“ antraštėje turi būti: Seimo nariai, Nedalyvavo, Prieš, Už, Susilaikė, Registravosi, Už A, Už B.");
      }

      const data = [];

      for (let i = 1; i < rows.length; i++) {
        const r = rows[i];
        const name = r[idxName] || "";
        if (!name) continue;

        function num(idx) {
          const v = (r[idx] || "").replace(",", ".").trim();
          const n = Number(v);
          return Number.isFinite(n) ? n : 0;
        }

        const ned = num(idxNedalyvavo);
        const pr  = num(idxPries);
        const uz  = num(idxUz);
        const sus = num(idxSusilaike);
        const reg = num(idxRegistr);
        const uza = num(idxUzA);
        const uzb = num(idxUzB);

        const partyName = partyMap[name] || "";
        const partyCategory = getPartyCategory(partyName);

        data.push({
          name,
          partyName,
          partyCategory,
          nedalyvavo: ned,
          pries: pr,
          uz,
          susilaike: sus,
          registravosi: reg,
          uza,
          uzb
        });
      }

      return data;
    }

    function buildPartyFilterOptions(rows) {
      const set = new Set();
      rows.forEach(r => {
        if (r.partyCategory) set.add(r.partyCategory);
      });
      const sorted = Array.from(set).sort((a, b) => a.localeCompare(b, "lt"));
      partyFilterEl.innerHTML = "";
      const allOpt = document.createElement("option");
      allOpt.value = "ALL";
      allOpt.textContent = "Visos partijos";
      partyFilterEl.appendChild(allOpt);

      sorted.forEach(cat => {
        const opt = document.createElement("option");
        opt.value = cat;
        opt.textContent = cat;
        partyFilterEl.appendChild(opt);
      });
    }

    function applyFilterAndSort() {
      if (!allRows.length) return;

      let rows = allRows.slice();

      // filtras pagal partiją
      if (currentPartyFilter !== "ALL") {
        rows = rows.filter(r => r.partyCategory === currentPartyFilter);
      }

      // rikiavimas
      const mode = currentSort; // pvz. "nedalyvavo_desc"
      if (mode === "name_asc") {
        rows.sort((a, b) => a.name.localeCompare(b.name, "lt"));
      } else if (mode === "party_asc") {
        rows.sort((a, b) => {
          const p = a.partyCategory.localeCompare(b.partyCategory, "lt");
          if (p !== 0) return p;
          return a.name.localeCompare(b.name, "lt");
        });
      } else {
        const [field, dir] = mode.split("_"); // pvz. ["nedalyvavo","desc"]
        const multiplier = dir === "asc" ? 1 : -1;

        const fieldMap = {
          "nedalyvavo": "nedalyvavo",
          "pries": "pries",
          "uz": "uz",
          "susilaike": "susilaike",
          "registravosi": "registravosi",
          "uza": "uza",
          "uzb": "uzb"
        };

        const prop = fieldMap[field];
        if (prop) {
          rows.sort((a, b) => {
            const diff = (a[prop] - b[prop]) * multiplier;
            if (diff !== 0) return diff;
            return a.name.localeCompare(b.name, "lt");
          });
        }
      }

      renderTable(rows);
    }

    function renderTable(rows) {
      tableBody.innerHTML = "";
      rows.forEach((r, idx) => {
        const tr = document.createElement("tr");

        const tdIndex = document.createElement("td");
        tdIndex.textContent = idx + 1;
        tdIndex.className = "number-cell";
        tr.appendChild(tdIndex);

        const tdName = document.createElement("td");
        tdName.textContent = r.name;
        tdName.className = "name-cell";
        tr.appendChild(tdName);

        const tdParty = document.createElement("td");
        tdParty.className = "party-cell";
        if (r.partyName) {
          const span = document.createElement("span");
          span.className = "party-badge";
          span.textContent = r.partyName;
          span.style.backgroundColor = getPartyColor(r.partyCategory);
          tdParty.appendChild(span);
        }
        tr.appendChild(tdParty);

        function addNumCell(value) {
          const td = document.createElement("td");
          td.textContent = value;
          td.className = "number-cell";
          tr.appendChild(td);
        }

        addNumCell(r.nedalyvavo);
        addNumCell(r.pries);
        addNumCell(r.uz);
        addNumCell(r.susilaike);
        addNumCell(r.registravosi);
        addNumCell(r.uza);
        addNumCell(r.uzb);

        tableBody.appendChild(tr);
      });

      statusEl.textContent = "Duomenys įkelti. Galite filtruoti ir rikiuoti lentelę.";
      errorEl.style.display = "none";
    }

    partyFilterEl.addEventListener("change", () => {
      currentPartyFilter = partyFilterEl.value || "ALL";
      applyFilterAndSort();
    });

    sortSelectEl.addEventListener("change", () => {
      currentSort = sortSelectEl.value || "name_asc";
      applyFilterAndSort();
    });

    (async function init() {
      try {
        const partyMap = await loadMembersParties();
        const stats = await loadStats(partyMap);
        allRows = stats;
        buildPartyFilterOptions(allRows);
        applyFilterAndSort();
      } catch (err) {
        console.error(err);
        statusEl.textContent = "";
        errorEl.textContent = err.message || "Įvyko klaida.";
        errorEl.style.display = "block";
      }
    })();
  </script>
</body>
</html>
