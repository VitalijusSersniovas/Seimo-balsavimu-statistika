<!DOCTYPE html>
<html lang="lt">
<head>
  <meta charset="UTF-8" />
  <title>Seimo narių balsavimo statistika</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 20px;
      font-size: 0.95rem;
    }

    h1 {
      font-size: 1.6rem;
      margin-bottom: 0.2rem;
    }

    .subtitle {
      font-size: 0.96rem;
      color: #555;
      margin-bottom: 0.3rem;
    }

    .period {
      font-size: 0.95rem;
      margin-bottom: 0.8rem;
    }

    .source-note {
      margin: 6px 0 16px 0;
      padding: 8px 12px;
      border-left: 4px solid #555;
      background: #f9f9f9;
      font-size: 0.9rem;
      line-height: 1.4;
    }

    .source-note em {
      font-style: italic;
    }

    label {
      font-weight: 600;
      font-size: 0.95rem;
    }

    select {
      min-width: 220px;
      padding: 4px 8px;
      font-size: 0.95rem;
      margin: 4px 0 10px 0;
    }

    .filters-row {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: center;
      margin-bottom: 8px;
    }

    .filters-row > div {
      display: flex;
      flex-direction: column;
    }

    .status {
      margin-top: 4px;
      margin-bottom: 8px;
      font-size: 0.9rem;
      color: #555;
    }

    .error {
      color: #b00020;
      font-weight: 600;
      margin-top: 6px;
      font-size: 0.9rem;
    }

    .table-wrapper {
      max-width: 100%;
      overflow-x: auto;
    }

    .table-container {
      max-height: 75vh;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      min-width: 900px;
    }

    th, td {
      border-bottom: 1px solid #e0e0e0;
      padding: 4px 8px;
      font-size: 0.9rem;
      line-height: 1.25;
    }

    th {
      background: #f6f6f6;
      text-align: center;
      font-weight: 700;
      position: sticky;
      top: 0;
      z-index: 2;
    }

    tr:nth-child(even) td {
      background: #fafafa;
    }

    td.index-cell {
      width: 40px;
      text-align: center;
      white-space: nowrap;
    }

    td.name-cell {
      white-space: nowrap;
      text-align: left;
    }

    /* PARTIJA – SUCENTRUOTA */
    td.party-cell {
      white-space: nowrap;
      text-align: center;
    }

    /* SKAITINIAI STULPELIAI – SUCENTRUOTI */
    td.number-cell {
      text-align: center;
      white-space: nowrap;
    }

    .party-badge {
      display: inline-block;
      padding: 2px 9px;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 600;
      color: #fff;
      white-space: nowrap;
    }

    .explanation {
      margin-top: 8px;
      font-size: 0.86rem;
      color: #555;
      font-style: italic;
    }

    @media (max-width: 768px) {
      body {
        margin: 10px;
        font-size: 0.9rem;
      }
      h1 {
        font-size: 1.3rem;
      }
      .subtitle, .period {
        font-size: 0.9rem;
      }
      select {
        min-width: 200px;
      }
      table {
        min-width: 850px;
      }
    }
  </style>
</head>
<body>
  <h1>Seimo narių balsavimo statistika</h1>
  <div class="subtitle">Metinė statistika: kiek kartų kiekvienas Seimo narys balsavo „Už“, „Prieš“, „Susilaikė“, „Nedalyvavo“, „Registravosi“ ir t. t.</div>
  <div class="period"><b>Pirmieji kadencijos metai:</b> 2024-11-14 – 2025-11-14</div>

  <div class="source-note">
    <b>Privaloma šaltinio nuoroda.</b><br />
    Naudojant, cituojant ar dalinantis šioje lentelėje pateikta informacija, būtina aiškiai nurodyti šaltinį:<br />
    <em>„Duomenys paimti iš Seimo nario Vitalijaus Šeršniovo parengto šaltinio.“</em>
  </div>

  <div class="filters-row">
    <div>
      <label for="partyFilter">Filtruoti pagal partiją / frakciją:</label>
      <select id="partyFilter">
        <option value="ALL">Visos partijos</option>
      </select>
    </div>
    <div>
      <label for="sortSelect">Rikiuoti pagal rodiklį:</label>
      <select id="sortSelect">
        <option value="name-asc">Seimo narys (abėcėlė)</option>
        <option value="name-desc">Seimo narys (atvirkštine abėcėle)</option>
        <option value="party-asc">Partija / frakcija (A–Ž)</option>
        <option value="party-desc">Partija / frakcija (Ž–A)</option>
        <option disabled>──────────</option>
        <option value="nedalyvavo-desc">Nedalyvavo (↓)</option>
        <option value="nedalyvavo-asc">Nedalyvavo (↑)</option>
        <option value="pries-desc">Prieš (↓)</option>
        <option value="pries-asc">Prieš (↑)</option>
        <option value="uz-desc">Už (↓)</option>
        <option value="uz-asc">Už (↑)</option>
        <option value="susilaike-desc">Susilaikė (↓)</option>
        <option value="susilaike-asc">Susilaikė (↑)</option>
        <option value="registravosi-desc">Registravosi (↓)</option>
        <option value="registravosi-asc">Registravosi (↑)</option>
        <option value="uza-desc">Už A (↓)</option>
        <option value="uza-asc">Už A (↑)</option>
        <option value="uzb-desc">Už B (↓)</option>
        <option value="uzb-asc">Už B (↑)</option>
      </select>
    </div>
  </div>

  <div id="status" class="status">Kraunami duomenys...</div>
  <div id="error" class="error" style="display:none;"></div>

  <div class="table-wrapper">
    <div class="table-container">
      <table id="dataTable">
        <thead>
          <tr>
            <th>#</th>
            <th>Seimo narys</th>
            <th>Partija / frakcija</th>
            <th>Nedalyvavo</th>
            <th>Prieš</th>
            <th>Už</th>
            <th>Susilaikė</th>
            <th>Registravosi</th>
            <th>Už A</th>
            <th>Už B</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <!-- Eilutės bus sugeneruotos čia -->
        </tbody>
      </table>
    </div>
  </div>

  <div class="explanation">
    Skaičiai rodo, kiek kartų kiekvienas Seimo narys balsavo atitinkamu būdu per pasirinktą laikotarpį.
  </div>

  <script>
    // ======== PARTIJŲ KATEGORIJOS IR SPALVOS ========
    const categoryColors = {
      "Tėvynės sąjunga–LKD": "#43BBAE",
      "Liberalai": "#FDBB38",
      "Demokratai": "#3A5778",
      "Socialdemokratai": "#FA0016",
      "Lietuvos valstiečių, žaliųjų ir KŠS frakcija": "#95D05F",
      "Mišri grupė": "#868A8D",
      "Nemuno aušra": "#9A4418"
    };

    function getPartyCategory(partyName) {
      if (!partyName) return "";
      const p = partyName.toLowerCase();

      if (p.startsWith("mišri grupė")) return "Mišri grupė";
      if (p.includes("nemuno aušra")) return "Nemuno aušra";
      if (p.includes("tėvynės sąjunga") || p.includes("tėvynės sajunga") || p.includes("ts-lkd")) {
        return "Tėvynės sąjunga–LKD";
      }
      if (p.includes("liberalų sąjūdis") || p.includes("liberalai")) {
        return "Liberalai";
      }
      if (p.includes("socialdemokrat")) {
        return "Socialdemokratai";
      }
      if (p.includes("demokratų sąjunga") || p.includes("vardan lietuvos")) {
        return "Demokratai";
      }
      if (p.includes("valstiečių") || p.includes("žaliųjų") || p.includes("žaliuju") || p.includes("kšs")) {
        return "Lietuvos valstiečių, žaliųjų ir KŠS frakcija";
      }
      return partyName.trim();
    }

    function getPartyColor(category) {
      if (!category) return "#9e9e9e";
      return categoryColors[category] || "#9e9e9e";
    }

    // ======== GLOBALŪS KINTAMIEJI ========
    const statusEl = document.getElementById("status");
    const errorEl = document.getElementById("error");
    const tableBody = document.getElementById("tableBody");
    const partyFilterSelect = document.getElementById("partyFilter");
    const sortSelect = document.getElementById("sortSelect");

    let allRows = []; // {name, partyName, partyCategory, nedalyvavo, pries, uz, susilaike, registravosi, uza, uzb}
    let currentPartyFilter = "ALL";
    let currentSort = { key: "name", direction: "asc" };

    // ======== CSV SKAITYMAS ========
    async function fetchTextSafe(url) {
      const resp = await fetch(url);
      if (!resp.ok) {
        throw new Error("Nepavyko nuskaityti failo: " + url);
      }
      return await resp.text();
    }

    function parseCSV(text) {
      const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
      if (lines.length === 0) return { headers: [], rows: [] };

      const delimiter = lines[0].includes(";") ? ";" : ",";
      const headers = lines[0].split(delimiter).map(h => h.trim());
      const rows = [];

      for (let i = 1; i < lines.length; i++) {
        const line = lines[i];
        if (!line.trim()) continue;
        const cols = line.split(delimiter);
        rows.push(cols.map(c => c.trim()));
      }

      return { headers, rows };
    }

    function mapMembersParties(parsed) {
      const { headers, rows } = parsed;

      const idxMember = headers.findIndex(h => h.toLowerCase().includes("member"));
      const idxParty  = headers.findIndex(h => h.toLowerCase().includes("party"));

      const map = {};
      if (idxMember === -1 || idxParty === -1) {
        return map;
      }

      for (const cols of rows) {
        const member = (cols[idxMember] || "").trim();
        const party  = (cols[idxParty] || "").trim();
        if (!member) continue;
        map[member] = party;
      }
      return map;
    }

    function parseMainVotes(parsed, membersPartyMap) {
      const { headers, rows } = parsed;

      function idxOf(possible) {
        const targets = possible.map(s => s.toLowerCase());
        return headers.findIndex(h => {
          const hl = h.toLowerCase();
          return targets.some(t => hl === t || hl.includes(t));
        });
      }

      const idxName        = idxOf(["seimo nariai", "seimo narys"]);
      const idxNedalyvavo  = idxOf(["nedalyvavo"]);
      const idxPries       = idxOf(["prieš", "pries"]);

      // PAGRINDINIS „UŽ“ – tiksliai tik šis stulpelis, ne „Už A“ / „Už B“
      const idxUz = headers.findIndex(h => {
        const hl = h.toLowerCase().replace(/["']/g, "").trim();
        return hl === "už" || hl === "uz";
      });

      const idxSusilaike   = idxOf(["susilaikė", "susilaike"]);
      const idxRegistravosi= idxOf(["registravosi"]);
      const idxUzA         = idxOf(["už a", "uz a"]);
      const idxUzB         = idxOf(["už b", "uz b"]);

      if (idxName === -1) {
        throw new Error("„metu_balsavimas1.csv“ antraštėje turi būti stulpelis „Seimo nariai“ arba „Seimo narys“.");
      }

      const result = [];

      for (const cols of rows) {
        const name = (cols[idxName] || "").trim();
        if (!name) continue;

        function num(idx) {
          if (idx === -1) return 0;
          const v = (cols[idx] || "").replace(",", ".").trim();
          const n = Number(v);
          return Number.isFinite(n) ? n : 0;
        }

        const row = {
          name,
          partyName: membersPartyMap[name] || "",
          partyCategory: getPartyCategory(membersPartyMap[name] || ""),
          nedalyvavo: num(idxNedalyvavo),
          pries: num(idxPries),
          uz: num(idxUz),
          susilaike: num(idxSusilaike),
          registravosi: num(idxRegistravosi),
          uza: num(idxUzA),
          uzb: num(idxUzB)
        };

        result.push(row);
      }

      return result;
    }

    function buildPartyFilterOptions() {
      const set = new Set();
      allRows.forEach(r => {
        if (r.partyCategory && r.partyCategory.trim()) {
          set.add(r.partyCategory.trim());
        }
      });

      const categories = Array.from(set).sort((a, b) => a.localeCompare(b, "lt"));

      partyFilterSelect.innerHTML = "";
      const allOpt = document.createElement("option");
      allOpt.value = "ALL";
      allOpt.textContent = "Visos partijos";
      partyFilterSelect.appendChild(allOpt);

      categories.forEach(cat => {
        const opt = document.createElement("option");
        opt.value = cat;
        opt.textContent = cat;
        partyFilterSelect.appendChild(opt);
      });

      currentPartyFilter = "ALL";
    }

    function applyFilterAndSort() {
      let rows = allRows.slice();

      if (currentPartyFilter !== "ALL") {
        rows = rows.filter(r => r.partyCategory === currentPartyFilter);
      }

      const key = currentSort.key;
      const dir = currentSort.direction === "asc" ? 1 : -1;

      rows.sort((a, b) => {
        if (key === "name") {
          return a.name.localeCompare(b.name, "lt") * dir;
        }
        if (key === "party") {
          return a.partyCategory.localeCompare(b.partyCategory, "lt") * dir;
        }

        // skaitiniai laukai
        return (a[key] - b[key]) * dir;
      });

      renderTable(rows);
    }

    function renderTable(rows) {
      tableBody.innerHTML = "";
      rows.forEach((row, idx) => {
        const tr = document.createElement("tr");

        const tdIndex = document.createElement("td");
        tdIndex.textContent = idx + 1;
        tdIndex.className = "index-cell";

        const tdName = document.createElement("td");
        tdName.textContent = row.name;
        tdName.className = "name-cell";

        const tdParty = document.createElement("td");
        tdParty.className = "party-cell";
        if (row.partyName) {
          const span = document.createElement("span");
          span.className = "party-badge";
          span.textContent = row.partyName;
          span.style.backgroundColor = getPartyColor(row.partyCategory);
          tdParty.appendChild(span);
        } else {
          tdParty.textContent = "";
        }

        function makeNumberCell(value) {
          const td = document.createElement("td");
          td.textContent = value;
          td.className = "number-cell";
          return td;
        }

        const tdNed = makeNumberCell(row.nedalyvavo);
        const tdPr  = makeNumberCell(row.pries);
        const tdUz  = makeNumberCell(row.uz);
        const tdSus = makeNumberCell(row.susilaike);
        const tdReg = makeNumberCell(row.registravosi);
        const tdUzA = makeNumberCell(row.uza);
        const tdUzB = makeNumberCell(row.uzb);

        tr.appendChild(tdIndex);
        tr.appendChild(tdName);
        tr.appendChild(tdParty);
        tr.appendChild(tdNed);
        tr.appendChild(tdPr);
        tr.appendChild(tdUz);
        tr.appendChild(tdSus);
        tr.appendChild(tdReg);
        tr.appendChild(tdUzA);
        tr.appendChild(tdUzB);

        tableBody.appendChild(tr);
      });
    }

    // ======== EVENTAI ========
    partyFilterSelect.addEventListener("change", () => {
      currentPartyFilter = partyFilterSelect.value || "ALL";
      applyFilterAndSort();
    });

    sortSelect.addEventListener("change", () => {
      const val = sortSelect.value;
      if (!val) return;
      const [key, direction] = val.split("-");
      currentSort = { key, direction };
      applyFilterAndSort();
    });

    // ======== INIT ========
    (async function init() {
      try {
        statusEl.textContent = "Kraunami duomenys iš „metu_balsavimas1.csv“ ir „members_parties.csv“...";

        const [mainText, partiesText] = await Promise.all([
          fetchTextSafe("metu_balsavimas1.csv"),
          fetchTextSafe("members_parties.csv")
        ]);

        const parsedParties = parseCSV(partiesText);
        const membersPartyMap = mapMembersParties(parsedParties);

        const parsedMain = parseCSV(mainText);
        allRows = parseMainVotes(parsedMain, membersPartyMap);

        buildPartyFilterOptions();

        currentSort = { key: "name", direction: "asc" };
        applyFilterAndSort();

        statusEl.textContent = "Duomenys įkelti. Galite filtruoti ir rikiuoti lentelę.";
        errorEl.style.display = "none";
      } catch (err) {
        console.error(err);
        statusEl.textContent = "";
        errorEl.textContent = err.message;
        errorEl.style.display = "block";
      }
    })();
  </script>
</body>
</html>
